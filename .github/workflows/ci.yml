name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Hammerspoon
        uses: brennovich/action-setup-hammerspoon@v1
        with:
          start-hammerspoon: false

      - name: Install config and tests
        run: |
          rsync -a --exclude='.git' . ~/.hammerspoon/
          # Ensure CLI is available for hs -c
          echo 'hs.ipc.cliInstall()' >> ~/.hammerspoon/init.lua

      - name: Start Hammerspoon
        run: |
          /Applications/Hammerspoon.app/Contents/MacOS/Hammerspoon &
          sleep 5

      - name: Run tests
        run: |
          output=$(hs -c "local r = require('tests'); print('EXIT:' .. (r.failed > 0 and 1 or 0))" 2>&1) || true
          echo "$output"
          exit_code=$(echo "$output" | (grep '^EXIT:' || echo 'EXIT:1') | cut -d: -f2)
          exit "${exit_code:-1}"
